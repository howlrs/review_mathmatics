# 数学I: データの分析 (3) 相関関係 (Session 21)

**対象**: 社会人エンジニア (Rust/Go)
**学習目標**: 共分散と相関係数の定義を理解し、2つの変量間の線形関係を定量化する。散布図の読み取りや、因果関係と相関関係の違いについても学ぶ。

---

## Phase 1: Foundational Check (基礎確認 10問)

**指針**: 「困ったときは『定義』に還れ」。相関係数 $r$ は、共分散 $s_{xy}$ をそれぞれの標準偏差 $s_x, s_y$ で割って正規化したものである。

1.  **[散布図]** 次の $(x, y)$ のデータについて、散布図 (Scatter Plot) を描いたとき、点は右上がりか、右下がりか。
    $$ (1, 2), (2, 3), (3, 5), (4, 4), (5, 6) $$

2.  **[共分散の定義]** 次のデータについて、共分散 $s_{xy}$ を求めよ。
    $$ (1, 2), (3, 6) $$
    > **Step**:
    > 1. $\bar{x}, \bar{y}$ を求める。
    > 2. 偏差の積 $(x_i - \bar{x})(y_i - \bar{y})$ を求める。
    > 3. その平均をとる。

3.  **[共分散の計算]** 次のデータについて、共分散 $s_{xy}$ を求めよ。
    $$ (2, 5), (4, 1), (6, 3) $$

4.  **[相関係数の定義]** 共分散 $s_{xy} = 4$、標準偏差 $s_x = 2, s_y = 4$ のとき、相関係数 $r$ を求めよ。
    > **Formula**: $r = \frac{s_{xy}}{s_x s_y}$。

5.  **[相関係数の範囲]** 相関係数 $r$ のとりうる値の範囲を答えよ。
    > **Prog Link**: コサイン類似度 (Cosine Similarity) と同じく $-1$ から $1$ の範囲。

6.  **[相関の強さ]** $r = 0.9$ と $r = -0.8$ では、どちらが「相関が強い」といえるか。
    > **Tip**: 絶対値 $|r|$ で判断する。

7.  **[無相関]** 相関係数が $0$ に近いとき、2つの変量の間にはどのような関係がないといえるか。
    > **Logic**: 「線形」の関係がない。非線形な関係（例: $y=x^2$）はあるかもしれない。

8.  **[データの変換]** 変量 $x, y$ の相関係数が $r=0.6$ のとき、 $u = 2x, v = 3y$ と変換した後の相関係数 $r_{uv}$ はいくらか。
    > **Logic**: 相関係数はスケール不変 (Scale Invariant)。

9.  **[データの変換]** 変量 $x, y$ の相関係数が $r=0.6$ のとき、 $u = -x, v = y$ と変換した後の相関係数 $r_{uv}$ はいくらか。
    > **Tip**: 符号が反転する場合、相関の向きも逆になる。

10. **[因果関係]** 「アイスクリームの売上」と「水難事故の件数」には正の相関がある。これは因果関係か？
    > **Maxim**: 「なぜ？は理解のエンジン」。擬似相関 (Spurious Correlation)。共通の要因（気温）がある。

---

## Phase 2: Applied Mastery (応用・実践 10問)

**指針**: 「条件を使い切ったか確認せよ」。共分散の公式 $\overline{xy} - \bar{x}\bar{y}$ や、ベクトルの内積としての解釈を活用せよ。

11. **[共分散の公式]**
    共分散 $s_{xy}$ は $\overline{xy} - \bar{x}\bar{y}$ （積の平均 - 平均の積）でも求められる。データ $(1, 2), (3, 6)$ でこれを確認せよ。

12. **[相関係数の計算]**
    次のデータの相関係数を求めよ。
    $$ (1, 1), (2, 3), (3, 2) $$

13. **[ベクトルとの関係]**
    データベクトル $\vec{x} = (x_1-\bar{x}, \dots, x_n-\bar{x})$ と $\vec{y} = (y_1-\bar{y}, \dots, y_n-\bar{y})$ のなす角を $\theta$ とするとき、相関係数 $r$ は $\cos \theta$ に等しいことを示せ。
    > **Prog Link**: 幾何学的解釈。データセットをベクトル空間上の点とみなす。

14. **[回帰直線]** (発展)
    データ $(x, y)$ の相関係数が $r$、標準偏差が $s_x, s_y$ のとき、 $x$ から $y$ を予測する回帰直線 $y = ax + b$ の傾き $a$ を $r, s_x, s_y$ で表せ。
    > **Formula**: $a = r \frac{s_y}{s_x}$。

15. **[相関係数の性質]**
    すべてのデータが直線 $y = -2x + 5$ 上にあるとき、相関係数 $r$ の値はいくらか。

16. **[誤りの修正]**
    5組のデータがあり、 $\bar{x}=2, \bar{y}=3, \overline{xy}=7, s_x=1, s_y=2$ であった。しかし、1組のデータ $(2, 3)$ が誤りで、正しくは $(4, 1)$ であった。修正後の共分散を求めよ。
    > **Algorithm**: $\sum xy$ と $\sum x, \sum y$ を修正して再計算。

17. **[順位相関]** (発展)
    データそのものではなく、データの「順位」の相関をとる方法（スピアマンの順位相関係数）がある。外れ値がある場合、ピアソンの積率相関係数と比べてどのような利点があるか。
    > **Prog Link**: ロバスト性。ソートアルゴリズムの応用。

18. **[相関行列]**
    3つの変量 $x, y, z$ があり、 $r_{xy}=0.8, r_{yz}=0.6$ である。 $x$ と $z$ の相関について何がいえるか（必ず正になるか、など）。
    > **Logic**: 必ずしも強い正の相関があるとは限らない（偏相関の概念）。

19. **[シンプソンのパラドックス]**
    全体で見ると正の相関があるが、グループ分けすると負の相関が見られるような状況の具体例を挙げよ。

20. **[プログラミング]**
    2つの配列 `x`, `y` を受け取り、相関係数を返す関数 `correlation(x, y)` を実装する際の、ゼロ除算（標準偏差が0の場合）の処理について述べよ。
    > **Prog Link**: エッジケース処理。すべての値が同じ場合、相関は定義されない（NaN）。

---

## 解答と解説

### Phase 1

1.  **右上がり**
    *   $x$ が増えると $y$ も増える傾向。
2.  **2**
    *   $\bar{x}=2, \bar{y}=4$。
    *   偏差: $(-1, -2), (1, 2)$。
    *   積: $2, 2$。平均: $2$。
3.  **-2**
    *   $\bar{x}=4, \bar{y}=3$。
    *   偏差: $(-2, 2), (0, -2), (2, 0)$。
    *   積: $-4, 0, 0$。平均: $-4/3$。
    *   (計算ミス確認: $\bar{x}=(2+4+6)/3=4, \bar{y}=(5+1+3)/3=3$。
    *   $(2-4)(5-3) = -2 \times 2 = -4$。
    *   $(4-4)(1-3) = 0 \times -2 = 0$。
    *   $(6-4)(3-3) = 2 \times 0 = 0$。
    *   和 $-4$。平均 $-4/3$。
    *   答え: $-4/3$。
    *   解説修正: **-4/3**)
4.  **0.5**
    *   $4 / (2 \times 4) = 0.5$。
5.  **$-1 \le r \le 1$**
6.  **$r = 0.9$**
    *   $|0.9| > |-0.8|$。
7.  **線形の関係（直線的な関係）**
8.  **0.6**
    *   正の定数倍は相関係数を変えない。
9.  **-0.6**
    *   $u$ は負の倍数なので符号が反転する。
10. **因果関係ではない（擬似相関）**

### Phase 2

11. **2**
    *   $\overline{xy} = (2 + 18)/2 = 10$。
    *   $\bar{x}\bar{y} = 2 \times 4 = 8$。
    *   $10 - 8 = 2$。一致する。
12. **0.5**
    *   $\bar{x}=2, \bar{y}=2$。
    *   偏差積: $(-1)(-1)=1, (0)(1)=0, (1)(0)=0$。共分散 $1/3$。
    *   $x$の分散: $((-1)^2+0^2+1^2)/3 = 2/3$。 $s_x = \sqrt{2/3}$。
    *   $y$の分散: $((-1)^2+1^2+0^2)/3 = 2/3$。 $s_y = \sqrt{2/3}$。
    *   $r = (1/3) / (2/3) = 0.5$。
13. **証明**
    *   内積の定義 $\vec{a}\cdot\vec{b} = |\vec{a}||\vec{b}|\cos\theta$。
    *   共分散は内積$/n$、標準偏差はノルム$/\sqrt{n}$。
    *   $r = \frac{\vec{x}\cdot\vec{y}/n}{|\vec{x}|/\sqrt{n} \cdot |\vec{y}|/\sqrt{n}} = \frac{\vec{x}\cdot\vec{y}}{|\vec{x}||\vec{y}|} = \cos \theta$。
14. **$a = r \frac{s_y}{s_x}$**
15. **-1**
    *   完全に一直線上にあり、傾きが負なので。
16. **-0.2**
    *   $n=5$。 $\sum xy = 7 \times 5 = 35$。
    *   修正: $35 - (2\times 3) + (4\times 1) = 35 - 6 + 4 = 33$。 $\overline{xy}_{new} = 33/5 = 6.6$。
    *   $\sum x = 10 \to 10-2+4=12 \to \bar{x}=2.4$。
    *   $\sum y = 15 \to 15-3+1=13 \to \bar{y}=2.6$。
    *   $s_{xy} = 6.6 - 2.4 \times 2.6 = 6.6 - 6.24 = 0.36$。
    *   (計算ミス確認: 元の $\overline{xy}=7$。 $s_{xy}$ ではない。
    *   問題文「共分散を求めよ」。
    *   答え: 0.36。
    *   解説修正: **0.36**)
17. **解説**
    *   外れ値の影響を受けにくい（ロバスト）。非線形でも単調増加なら1になる。
18. **必ずしも正ではない**
    *   $x$ と $y$ が近く、 $y$ と $z$ が近くても、 $x$ と $z$ が近いとは限らない（幾何学的には角度の問題）。
19. **例**
    *   大学入試の合格率（学部ごとの合格率は女子が高いが、全体では男子が高いなど）。
20. **解説**
    *   分母が0になる場合、相関係数は定義できない。 `NaN` を返すか、エラーとするか、仕様を決める必要がある。

